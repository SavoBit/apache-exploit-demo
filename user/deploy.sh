#!/bin/sh -e

[[ $APOCTL_NAMESPACE ]] || { echo "APOCTL_NAMESPACE is not set, source env?"; exit 2; }
[[ $APOCTL_TOKEN ]] || { echo "APOCTL_TOKEN is not set"; exit 2; }

KNAMESPACE=$(basename $APOCTL_NAMESPACE)

cd $(dirname $0) && cd ..

apoctl api import --file aporeto/policy.yaml || { echo "Aporeto policy install failed"; }
kubectl create ns $KNAMESPACE || { echo "Failed to create Kubernetes NS $KNAMESPACE"; }
kubectl create -f kubernetes
